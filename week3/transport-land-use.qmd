---
title: "Cape Town Transport and Land Use"
format: html
editor: visual
execute:
  echo: false
  warning: false
  message: false
---

## Introduction

The page illustrates the spatial relationships among

-   Public transport zones (PT2) (areas with relaxed parking requirements due to proximity to public transport service) (<https://odp-cctegis.opendata.arcgis.com/datasets/cctegis::parking-pt2-public-transport-zones/explore>)

-   Mixed-use intensification areas (where redevelopment to a mix of land uses is actively encouraged) (<https://odp-cctegis.opendata.arcgis.com/datasets/7dbcf28e3c534429bb7eefd68bbdf584_216>)

-   Taxi routes (<https://odp-cctegis.opendata.arcgis.com/datasets/2efbfd905a974d50be57c8641a2ea171_97>)

-   MyCiTi BRT stops (<https://odp-cctegis.opendata.arcgis.com/datasets/19684ea3f08b4c95ab4fe7099ed75e81_96>)

    ```{r}
    #| results: hide

    library(tidyverse)
    library(sf)
    library(here)
    library(units)
    library(knitr)
    library(RColorBrewer)
    library(maptiles)
    library(tidyterra)


    pt_zones <- here("week3",
                     "Parking_PT2_(Public_Transport)_Zones.geojson") |>
      st_read()  |>
      st_transform(32734) |>
      select(OBJECTID) |>
      mutate(type = "Public Transport Parking Zone")

    mixed_use <- here("week3",
                     "Mixed_Use_Intensification_Areas.geojson") |>
      st_read() |>
      st_transform(32734) |>
      select(OBJECTID) |>
      mutate(type = "Mixed Use Intensification Area")

    taxi_routes <- here("week3",
                        "Taxi_Routes.geojson") |>
      st_read() |>
      st_transform(32734)

    brt_stops <- here("week3",
                "Integrated_rapid_transit_(IRT)_system_MyCiTi_Bus_Stops.geojson") |>
      st_read() |>
      st_transform(32734)
    ```

The map below shows the extent of the data, as well as the areas in which subsequent maps on this page will focus.

```{r}
#|fig-height: 12

polygons <- rbind(mixed_use, pt_zones)

large_bbox <- st_bbox(polygons)
small_bbox <- st_bbox(pt_zones[48,])

large_square <- large_bbox |>
  st_as_sfc() |>
  st_as_sf() |>
  mutate(`Detail Area` = "Detail Area 1")

small_square <- small_bbox |>
  st_as_sfc() |>
  st_as_sf() |>
  mutate(`Detail Area` = "Detail Area 2")

squares <- rbind(large_square, small_square) 

base_map_all <- get_tiles(taxi_routes,
                      provider = "CartoDB.PositronNoLabels",
                      crop = TRUE,
                      zoom = 9)

base_map_d1 <- get_tiles(large_square,
                         provider = "CartoDB.PositronNoLabels",
                         crop = TRUE,
                         zoom = 10)

base_map_d2 <- get_tiles(small_square,
                         provider = "CartoDB.PositronNoLabels",
                         crop = TRUE,
                         zoom = 13)


ggplot() +
  geom_spatraster_rgb(data = base_map_all) +
  geom_sf(data = taxi_routes,
          aes(color = "Taxi route")) +
  geom_sf(data = polygons,
          aes(fill = type),
          color = NA) +
  geom_sf(data = brt_stops,
          size = 0.5,
          color = "lightblue") +
  geom_sf(data = squares,
          fill = NA,
          aes(lty = `Detail Area`)) +
  scale_fill_manual(name = "", 
                    values = c("darkgreen", "darkorange")) +
  scale_linetype_manual(name = "", values = c(2, 1)) +
  scale_color_manual(name = "", values = "tan") +
  theme_void()
  
  
```

## Relationships between BRT stops and taxi routes

This map shows the locations of BRT stops in Cape Town relative to taxi routes within Detail Area 1.

```{r}
#|fig-cap: "Locations of BRT stops with respect to taxi routes"
#|fig-height: 10

brt_stops <- brt_stops |>
  mutate(nearest_taxi = st_nearest_feature(brt_stops, taxi_routes)) |>
  mutate(taxi_dist = st_distance(brt_stops, 
                                 taxi_routes[nearest_taxi,],
                                 by_element = TRUE)) |>
  mutate(taxi_dist_m = as.numeric(taxi_dist)) |>
  mutate(close = ifelse(taxi_dist_m < 100, "Within 100 meters of a taxi route",
                        "Beyond 100 meters of a taxi route"))

ggplot(taxi_routes) +
  geom_spatraster_rgb(data = base_map_d1) +
  geom_sf(color = "tan",
          aes(lty = "Taxi route")) +
  geom_sf(data = brt_stops,
          size = 0.5,
          aes(color = taxi_dist_m)) +
  scale_color_viridis_c(
    name = "Distance from BRT stop\nto nearest taxi route\n(meters)",
                        trans = "log",
    breaks = breaks <- c(0.1, 1, 10, 100, 1000),
    labels = prettyNum(breaks)) +
  scale_linetype(name = "") +
  coord_sf(ylim = c(large_bbox["ymin"], large_bbox["ymax"]),
           xlim = c(large_bbox["xmin"], large_bbox["xmax"])) +
  theme_void()
```

The distance from a BRT stop to the nearest taxi route ranges from zero to 1.8 kilometers. The average distance from a BRT stop to the nearest taxi route is about 86 meters.

As shown in the table below, 79 percent of BRT stops are within 100 meters of the nearest taxi route.

```{r}
brt_stops |>
  st_drop_geometry() |>
  group_by(close) |>
  summarise(`Number of BRT stops` = n()) |>
  mutate(`Percent of BRT stops` = paste0(round(100 * `Number of BRT stops`/
                                         sum(`Number of BRT stops`)),
                                         "%")) |>
  kable()
```

The figure below shows the locations of BRT stops relative to a 100-meter buffer area around taxi routs within Detail Area 2.

```{r}
taxi_buffer <- 
  st_buffer(taxi_routes, dist = 100) |>
  st_union()

ggplot(taxi_buffer) +
  geom_spatraster_rgb(data = base_map_d2) +
  geom_sf(aes(fill = "Area within 100 meters of a taxi route"),
          color = NA,
          alpha = 0.6) +
  geom_sf(data = brt_stops,
          size = 1, 
          aes(color = close)) +
  scale_color_manual(name = "BRT stops",
                     values = c("pink",
                                "lightblue")) +
  scale_fill_manual(name = "", values = "tan") +
  coord_sf(ylim = c(small_bbox["ymin"], small_bbox["ymax"]),
           xlim = c(small_bbox["xmin"], small_bbox["xmax"])) +
  theme_void()
```

## Relationship between Public Transport Parking zones and BRT stops

This map shows the locations of BRT stops in Cape Town relative to Public Transport Parking Zones (where parking requirements are relaxed due to proximity to transit). The color of each zone varies by the number of BRT stops it contains. Of the 48 Public Transport Parking Zones, 36 do not contain any BRT stops. Three contain more than ten, and one contains more than 200.

```{r}
sf_use_s2(FALSE)

pt_zones <- pt_zones |>
  rename(zone_ID = OBJECTID)
    
brt_stop_by_zone <- brt_stops |>
  st_join(pt_zones) |>
  st_drop_geometry() |>
  group_by(zone_ID) |>
  summarise(num_stops = n())

pt_zones <- pt_zones |>
  left_join(brt_stop_by_zone) |>
  replace_na(list(num_stops = 0))

no_stop_zones <- pt_zones |> 
  filter(num_stops == 0)

ggplot(pt_zones) +
  geom_spatraster_rgb(data = base_map_d1) +
  geom_sf(data = brt_stops,
          size = 0.5,
          color = "lightblue",
          aes(shape = "BRT stop")) +
  geom_sf(aes(fill = num_stops,
              color = "Zero"),
            alpha = 0.7) +
  scale_fill_viridis_c(trans = "log",
                       breaks = c(1, 10, 100),
                       na.value = "gray",
                       name = "Number of BRT stops\nwithin each\npublic transport\nparking zone") +
  scale_color_manual(values=NA) +  
  scale_shape(name = "") +
  guides(color=guide_legend(override.aes=list(fill="gray", 
                                              color = NA),
                            title = NULL,
                            order = 3),
         fill = guide_colorbar(order = 2),
         shape = guide_legend(order = 1,
                              override.aes = list(color = "lightblue"))) +
    coord_sf(ylim = c(large_bbox["ymin"], large_bbox["ymax"]),
             xlim = c(large_bbox["xmin"], large_bbox["xmax"])) +
  theme_void() 
```

## Relationship between Mixed Use Intensification Areas and Public Transport Zones

```{r}
overlap_area <- st_intersection(pt_zones, mixed_use) |>
  st_area() |>
  sum() |>
  set_units("km^2")
  

mixed_use_area <- st_area(mixed_use) |>
  sum() |>
  set_units("km^2")

pt_area <- st_area(pt_zones) |>
  sum() |>
  set_units("km^2")
```

The total area included in Mixed Use Intensification Areas is 51.2 square kilometers and the total area included in Public Transport Zones is 69.7. 18.5 square kilometers of area are included in both a Mixed Use Intensification Area and a Public Transport Zone. This represents about 36 percent of the total area of Mixed Use Intensification Areas and 27 percent of the total area of Public Transport Zones.

The map below shows the overlap between Public Transport Zones and Mixed Use Intensification Areas for Detail Area 1.

```{r}
ggplot(polygons) +
  geom_spatraster_rgb(data = base_map_d1) +
    geom_sf(aes(fill = type),
          color = NA,
          alpha = 0.6) +
  scale_fill_manual(name = "", 
                    values = c("darkgreen", "darkorange")) +
  coord_sf(ylim = c(small_bbox["ymin"], small_bbox["ymax"]),
           xlim = c(small_bbox["xmin"], small_bbox["xmax"])) +
  theme_void()
```
